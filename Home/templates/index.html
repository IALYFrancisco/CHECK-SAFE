{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Check safe</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'css/Home.css' %}">
    <link rel="shortcut icon" href="{% static 'img/icons8-secure-32.png' %}" type="image/x-icon">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <header>
        <nav>
            <div class="logo-container">
                <img src="{% static 'img/icons8-secure-32.png' %}" alt="Logo de l'application" title="Logo de l'application">
                <h4>Check safe</h4>
            </div>
        </nav>
    </header>
    <main class="app-container">
        <section class="operation">
            <h2>Fraud detection</h2>
            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                {{ form.as_p }}
                <button>Start scan</button>
            </form>
        </section>

        {% if transactions %}
        <section class="statistics">
            <h3>ðŸ“Š Statistiques du scan</h3>
            <ul>
                <li>Total transactions : {{ stats.total }}</li>
                <li>Frauduleuses : {{ stats.fraudulent }}</li>
                <li>Saines : {{ stats.safe }}</li>
                <li>Pourcentage de fraude : {{ stats.fraud_percentage }}%</li>
                <li>Montant total : {{ stats.total_amount }} â‚¬</li>
                <li>Montant frauduleux : {{ stats.total_fraud_amount }} â‚¬</li>
            </ul>
        </section>

        <section class="charts">
            <canvas id="fraudByTypeChart"></canvas>
            <canvas id="fraudByCityChart"></canvas>
            <canvas id="topUsersChart"></canvas>
            <canvas id="scanTrendChart"></canvas>
        </section>
        {% endif %}

        <section class="result">
            {% if transactions %}
                <h4>RÃ©sultats du scan :</h4>
                <section class="user-list">
                    {% for transaction in transactions %}
                        <div class="user {% if transaction.type_fraude == 'Aucune' %}safe{% else %}not-safe{% endif %}">
                            <div class="profile-container">
                                <img src="{% static 'img/profile2.jpg' %}" alt="">
                            </div>
                            <div class="user-info">
                                <p class="name">{{ transaction.nom }}</p>
                                <p class="account-id">Transaction #{{ transaction.transaction_id }}</p>
                                <p class="town">{{ transaction.lieu_transaction }}</p>
                                <p class="fraud-type">Type de fraude : {{ transaction.type_fraude }}</p>
                            </div>
                        </div>
                    {% endfor %}
                </section>
            {% else %}
                <h5>Aucun rÃ©sultat, veuillez lancer le scan.</h5>
            {% endif %}
        </section>
    </main>

    {% if stats %}
    <script>
        const fraudByType = JSON.parse('{{ stats.fraud_by_type|escapejs }}');
        const fraudByCity = JSON.parse('{{ stats.fraud_by_city|escapejs }}');
        const topFraudUsers = JSON.parse('{{ stats.top_fraud_users|escapejs }}');
        const scanTrend = JSON.parse('{{ stats.scan_trend|escapejs }}');

        new Chart(document.getElementById('fraudByTypeChart'), {
            type: 'bar',
            data: {
                labels: Object.keys(fraudByType),
                datasets: [{
                    label: 'Types de fraude',
                    data: Object.values(fraudByType),
                    backgroundColor: 'rgba(255, 99, 132, 0.6)'
                }]
            }
        });

        new Chart(document.getElementById('fraudByCityChart'), {
            type: 'bar',
            data: {
                labels: Object.keys(fraudByCity),
                datasets: [{
                    label: 'Fraudes par ville',
                    data: Object.values(fraudByCity),
                    backgroundColor: 'rgba(54, 162, 235, 0.6)'
                }]
            }
        });

        new Chart(document.getElementById('topUsersChart'), {
            type: 'bar',
            data: {
                labels: Object.keys(topFraudUsers),
                datasets: [{
                    label: 'Utilisateurs Ã  risque',
                    data: Object.values(topFraudUsers),
                    backgroundColor: 'rgba(255, 206, 86, 0.6)'
                }]
            }
        });

        new Chart(document.getElementById('scanTrendChart'), {
            type: 'line',
            data: {
                labels: Object.keys(scanTrend),
                datasets: [{
                    label: 'Fraudes dÃ©tectÃ©es par date',
                    data: Object.values(scanTrend),
                    fill: false,
                    borderColor: '#FF5733',
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        title: { display: true, text: 'Date de scan' }
                    },
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'Nombre de fraudes' }
                    }
                }
            }
        });
    </script>
    {% endif %}
</body>
</html>
